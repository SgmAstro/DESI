#!/bin/bash
exec > >(tee 'pipeline.log') 2>&1

export USESBATCH=1
export RESET=1

export DRYRUN=''
# export DRYRUN='--dryrun'                                                                                                                                                

export NOOVERWRITE=''
#export NOOVERWRITE='--nooverwrite'

# ----------------------------- #
# export TILING_CATDIR=$HOME/data/
# export GOLD_DIR=$HOME/data/GAMA4/
# export RANDOMS_DIR=$HOME/data/GAMA4/randoms/

echo 'Assuming RESET='$RESET
echo 'Assuming DRYRUN='$DRYRUN
echo 'Assuming NOOVERWRITE='$NOOVERWRITE

if (( $RESET > 0 )); then
    echo
    echo '>>>>>  TRASHING GOLD_DIR AND RANDOMS  <<<<<.'
    echo 

    rm $GOLD_DIR/*.fits
    rm $RANDOMS_DIR/*.fits
    
    rm $GOLD_DIR/logs/*.log
    rm $RANDOMS_DIR/logs/*.log

    # rm gold_pipeline.log
    # rm gold_d8_pipeline.log

    # rm rand_pipeline.log
    # rm rand_d8_pipeline.log

    # ls -l $GOLD_DIR/
    # ls -l $RANDOMS_DIR/
    # ls -l $CODE_ROOT/logs/
fi

#  ----  Total of eight jobs, with correct dependency logic  ----
export RESET=0

#  ---------------------------------------------
cd $HOME

rm -rf ~/tmp; mkdir -p ~/tmp

cd ~/tmp/

git clone https://github.com/SgmAstro/DESI.git

cd ~/tmp/DESI/

git checkout bounddist_fixes # main

echo 'git branch assumed:  '$(git rev-parse --abbrev-ref HEAD)

export CODE_ROOT=~/tmp/DESI/

export PATH=$HOME/.conda/envs/lumfn/bin/:$CODE_ROOT/bin/:$PATH
export PYTHONPATH=$CODE_ROOT:$PYTHONPATH

mkdir -p $GOLD_DIR/logs/
mkdir -p $RANDOMS_DIR/logs/

#  --------------------------------------------- 

# Generate all steps up to reference LF. 
GOLD_JOBID=$(serialorparallel -p $USESBATCH -e DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE -s gold_pipeline -c $CODE_ROOT)

echo
echo '>>>>> GOLD JOB ID <<<<<'
echo $GOLD_JOBID

#
# https://slurm.schedmd.com/sbatch.html
#

# No dependency.  Generate all steps up to random fill factor and bound_dist. 
RAND_G9_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G9,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE  -s rand_pipeline -c $CODE_ROOT)
RAND_G12_JOBID=$(serialorparallel -p $USESBATCH -e FIELD=G12,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE -s rand_pipeline -c $CODE_ROOT)
RAND_G15_JOBID=$(serialorparallel -p $USESBATCH -e FIELD=G15,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE -s rand_pipeline -c $CODE_ROOT)

# Dependency on $GOLD_JOBID (gold ddp cat generated by gold_pipeline).
# Generate ddp1 randoms limited to ddp1 z limits - with corresponding fillfactors, bound_dist etc.  
RAND_DDP_G9_JOBID=$(serialorparallel   -p $USESBATCH -e FIELD=G9,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE  -d $GOLD_JOBID -s rand_ddp1_pipeline -c $CODE_ROOT)
RAND_DDP_G12_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G12,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE -d $GOLD_JOBID -s rand_ddp1_pipeline -c $CODE_ROOT)
RAND_DDP_G15_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G15,DRYRUN=$DRYRUN,RESET=$RESET,NOOVERWRITE=$NOOVERWRITE -d $GOLD_JOBID -s rand_ddp1_pipeline -c $CODE_ROOT)

echo
echo ' >>>>> RANDOM JOB IDS <<<<<'
echo $RAND_G9_JOBID
echo $RAND_G12_JOBID
echo $RAND_G15_JOBID

echo $RAND_DDP_G9_JOBID
echo $RAND_DDP_G12_JOBID
echo $RAND_DDP_G15_JOBID

# Requires ddp cat, & randoms; no reset required.  
RAND_D8_G9_JOBID=$(serialorparallel   -p $USESBATCH -e FIELD=G9,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE   -d $GOLD_JOBID,$RAND_G9_JOBID  -s rand_d8_pipeline -c $CODE_ROOT)
RAND_D8_G12_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G12,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE  -d $GOLD_JOBID,$RAND_G12_JOBID -s rand_d8_pipeline -c $CODE_ROOT)
RAND_D8_G15_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G15,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE  -d $GOLD_JOBID,$RAND_G15_JOBID -s rand_d8_pipeline -c $CODE_ROOT)

RAND_DDP_D8_G9_JOBID=$(serialorparallel   -p $USESBATCH -e FIELD=G9,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE   -d $GOLD_JOBID,$RAND_DDP_G9_JOBID  -s rand_ddp1_d8_pipeline -c $CODE_ROOT)
RAND_DDP_D8_G12_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G12,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE  -d $GOLD_JOBID,$RAND_DDP_G12_JOBID -s rand_ddp1_d8_pipeline -c $CODE_ROOT)
RAND_DDP_D8_G15_JOBID=$(serialorparallel  -p $USESBATCH -e FIELD=G15,DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE  -d $GOLD_JOBID,$RAND_DDP_G15_JOBID -s rand_ddp1_d8_pipeline -c $CODE_ROOT)

echo
echo ' >>>>> RANDOM D8 JOB IDS <<<<<'
echo $RAND_D8_G9_JOBID
echo $RAND_D8_G12_JOBID
echo $RAND_D8_G15_JOBID

echo $RAND_DDP_D8_G9_JOBID
echo $RAND_DDP_D8_G12_JOBID
echo $RAND_DDP_D8_G15_JOBID

# Requires ddp cat. & random fill factor.                                                                                                                                                            
# Note: runs all fields simultaneously.                                                                                                                                         
GOLD_D8_JOBID=$(serialorparallel -p $USESBATCH -e DRYRUN=$DRYRUN,NOOVERWRITE=$NOOVERWRITE -d $RAND_DDP_D8_G9_JOBID,$RAND_DDP_D8_G12_JOBID,$RAND_DDP_D8_G15_JOBID -s gold_d8_pipeline -c $CODE_ROOT)

echo
echo '>>>>>  GOLD D8 JOB IDS  <<<<<'
echo $GOLD_D8_JOBID
echo
echo '>>>>>  DONE.  <<<<<'
echo
echo
