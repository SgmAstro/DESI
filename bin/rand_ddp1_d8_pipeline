#!/bin/bash
#SBATCH -p cosma                                                                                                                                                                                     
#SBATCH -t 02:00:00 
#SBATCH -o rand_ddp1_d8_pipeline.log                                                                                                                                                                
#SBATCH -A durham                                                                                                                                                                                    
#SBATCH --nodes=1                                                                                                                                                                                    
#SBATCH --ntasks-per-node=1   
#SBATCH --open-mode=append

# Submit with:  sbatch rand_pipeline
# to qos of [debug, regular]
# See status with e.g. squeue -u mjwilson
# 
if [[ -z "${FIELD}" ]]; then
  export FIELD="G9"
else
  echo 'FIELD SET TO BE '$FIELD
fi

if [ -z ${DRYRUN+x} ]; then
  # export DRYRUN=''                                                                                                                                                                                
  export DRYRUN='--dryrun'
else
  echo 'DRYRUN SET TO BE '$DRYRUN
fi

export CODE_ROOT=$HOME/DESI/

export TILING_CATDIR=$HOME/data/
export GOLD_DIR=$HOME/data/GAMA4/
export RANDOMS_DIR=$HOME/data/GAMA4/randoms/

export PATH=$HOME/.conda/envs/lumfn/bin/:$HOME/DESI/bin/:$PATH
export PYTHONPATH=$HOME/$HOME/DESI/:$PYTHONPATH

echo
echo 'Environment:'
echo
echo 'Code: '$CODE_ROOT
echo 'Gold output dir.: '$GOLD_DIR
echo 'Randoms output dir: '$RANDOMS_DIR

cd $CODE_ROOT

# source /project/projectdirs/desi/software/desi_environment.sh master

echo 'Running randoms ddp1 d8 pipeline for field '$FIELD

DDP_FILE=$GOLD_DIR/gama_gold_ddp${DRYRUN/'--'/'_'}.fits                                                                                                                                            

if [ -f "$DDP_FILE" ]; then
    echo "Found DDP file"
else
    echo $DDP_FILE' does not exist.'
    exit 1
fi

# Assumes python gen_ddp_N8.py has been run. 
python gen_rand_ddp_N8.py --field $FIELD --prefix 'randoms_ddp1' $DRYRUN > $CODE_ROOT/logs/rand_ddp_N8_$FIELD.log

# TODO:  QA scripts need updated to point to RANDOMS_DIR, GOLD_DIR
# pytest

echo 'Done.'
